# ฺฏุฒุงุฑุด ุชุญูู ููุทู ููุงุด ุตูุญู ฺุช ฺฏุฑูู

## ๐ ุจุฑุฑุณ ูุนู ููุทู ููุงุด ุตูุญู

### 1. ูุฑูุฏ ุงููู ฺฉุงุฑุจุฑ ุจู ุตูุญู

**ููุทู ูุนู (ุฎุท 3319-3350 ุฏุฑ chat.blade.php):**

#### ุงูููุชโูุง Scroll Restore:
1. **ุงูููุช 1: `lastReadMessageId`** (ุฎุท 3320-3332)
   - ุงฺฏุฑ `lastReadMessageId` ุงุฒ ุฏุชุงุจุณ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ
   - ุจู ูพุงู ุจุง ID `msg-{lastReadMessageId}` ูโุฑูุฏ
   - ุงุฒ `scrollIntoView({ behavior: 'auto', block: 'center' })` ุงุณุชูุงุฏู ูโฺฉูุฏ
   - โ **ูุฒุช**: ฺฉุงุฑุจุฑ ุจู ุขุฎุฑู ูพุงู ุฎูุงูุฏู ุดุฏู ูโุฑูุฏ

2. **ุงูููุช 2: `sessionStorage`** (ุฎุท 3334-3344)
   - ุงฺฏุฑ scroll position ุฏุฑ `sessionStorage` ุฐุฎุฑู ุดุฏู ุจุงุดุฏ
   - ุจู ููุงู ูููุนุช scroll ูโุฑูุฏ
   - โ **ูุฒุช**: ูููุนุช ฺฉุงุฑุจุฑ ุจุนุฏ ุงุฒ refresh ุญูุธ ูโุดูุฏ

3. **ุงูููุช 3: ูพุงู ุตูุญู** (ุฎุท 3344-3350)
   - ุงฺฏุฑ ูฺ ูููุนุช ุฐุฎุฑู ูุดุฏู ุจุงุดุฏ
   - ุจู ุขุฎุฑู ูพุงู (ูพุงู ุตูุญู) ูโุฑูุฏ
   - โ๏ธ **ูุดฺฉู**: ุงฺฏุฑ ฺฉุงุฑุจุฑ ุจุฑุง ุงููู ุจุงุฑ ูุงุฑุฏ ุดูุฏุ ุจู ูพุงู ูโุฑูุฏ

### 2. ุฐุฎุฑู ูููุนุช Scroll

**ฺฉุฏูุง ุฐุฎุฑู ูููุนุช:**
- ุฎุท 1718: ูุจู ุงุฒ submit ูุฑู
- ุฎุท 2091: ููฺฏุงู ุชุฑฺฉ ุตูุญู (`beforeunload`)
- ุฎุท 2098: ููฺฏุงู scroll (ูุฑ scroll event)

**ูุดฺฉู**: ุฐุฎุฑูโุณุงุฒ ุฏุฑ ูุฑ scroll event ูโุชูุงูุฏ performance issue ุงุฌุงุฏ ฺฉูุฏ.

### 3. ุจูโุฑูุฒุฑุณุงู Last Read Message

**ููุทู ูุนู (ุฎุท 1671-1687):**
- ุจุง debounce 500ms
- ุขุฎุฑู ูพุงู visible ุฏุฑ viewport ุฑุง ุจูโุฑูุฒุฑุณุงู ูโฺฉูุฏ
- ููุท ูพุงูโูุง ุฏฺฏุฑุงู ุฑุง ุจูโุฑูุฒุฑุณุงู ูโฺฉูุฏ (ูู ูพุงูโูุง ุฎูุฏ ฺฉุงุฑุจุฑ)

**ุงุณุชูุงุฏู ุงุฒ IntersectionObserver (ุฎุท 2111-2141):**
- ููุช 50% ูพุงู visible ุดูุฏุ ุจูโุฑูุฒุฑุณุงู ูโุดูุฏ
- โ **ูุฒุช**: ุฏููโุชุฑ ุงุฒ scroll event

### 4. ุงุถุงูู ุดุฏู ูพุงูโูุง ุฌุฏุฏ (Polling)

**ููุทู ูุนู (group-chat.js ุฎุท 606-669):**
- ูุฑ 3 ุซุงูู ุฏุฑุฎูุงุณุช ุฌุฏุฏ ูโุฏูุฏ
- ูพุงูโูุง ุฌุฏุฏ ุฑุง ุงุถุงูู ูโฺฉูุฏ
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฏุฑ ูพุงู ุจุงุดุฏ (`isScrolledToBottom`) ู `scrollPositionRestored` set ูุดุฏู ุจุงุดุฏุ ุจู ูพุงู ูโุฑูุฏ
- โ๏ธ **ูุดฺฉู**: ููฺฉู ุงุณุช ุจุง scroll restore ุชุฏุงุฎู ุฏุงุดุชู ุจุงุดุฏ

---

## โ ูุดฺฉูุงุช ุดูุงุณุง ุดุฏู

### ูุดฺฉู 1: ููุทู ูพุฏุง ฺฉุฑุฏู "ุงููู ูพุงู ุฎูุงูุฏู ูุดุฏู" ูุฌูุฏ ูุฏุงุฑุฏ
- **ุดุฑุญ**: ุงฺฏุฑ `lastReadMessageId` ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ุจู ุขู ูพุงู ูโุฑูุฏ. ุงูุง ฺฉุงุฑุจุฑ ุงูุชุธุงุฑ ุฏุงุฑุฏ ุจู **ุงููู ูพุงู ุฎูุงูุฏู ูุดุฏู** (ุนู ูพุงู ุจุนุฏ ุงุฒ `lastReadMessageId`) ุจุฑูุฏ.
- **ุชุฃุซุฑ**: ฺฉุงุฑุจุฑ ุจุงุฏ ุฏุณุช scroll ฺฉูุฏ ุชุง ูพุงูโูุง ุฌุฏุฏ ุฑุง ุจุจูุฏ.

### ูุดฺฉู 2: ุงฺฏุฑ `lastReadMessageId` ุฏุฑ DOM ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏ
- **ุดุฑุญ**: ุงฺฏุฑ ูพุงู ุญุฐู ุดุฏู ุจุงุดุฏ ุง ูููุฒ render ูุดุฏู ุจุงุดุฏุ ูฺ fallback ูุฌูุฏ ูุฏุงุฑุฏ.
- **ุชุฃุซุฑ**: ฺฉุงุฑุจุฑ ุจู ุงูููุช 2 ุง 3 ูโุฑูุฏ ฺฉู ููฺฉู ุงุณุช ุตุญุญ ูุจุงุดุฏ.

### ูุดฺฉู 3: ุงฺฏุฑ ฺฉุงุฑุจุฑ ุจุฑุง ุงููู ุจุงุฑ ูุงุฑุฏ ุดูุฏ (`lastReadMessageId = null`)
- **ุดุฑุญ**: ุจุงุฏ ุจู ุงููู ูพุงู ฺฏุฑูู ุจุฑูุฏุ ูู ุจู ุขุฎุฑู ูพุงู.
- **ุชุฃุซุฑ**: ฺฉุงุฑุจุฑ ุงุฒ ุงูู ุจู ุขุฎุฑ ูโุฑูุฏ ู ุจุงุฏ ุฏุณุช ุจู ุงูู ุจุฑฺฏุฑุฏุฏ.

### ูุดฺฉู 4: ุชุฏุงุฎู ุจู Polling ู Scroll Restore
- **ุดุฑุญ**: Polling ูโุชูุงูุฏ ูููุนุช scroll ุฑุง ุชุบุฑ ุฏูุฏ ูุจู ุงุฒ ุงูฺฉู restore ฺฉุงูู ุดูุฏ.
- **ุชุฃุซุฑ**: ฺฉุงุฑุจุฑ ููฺฉู ุงุณุช ูููุนุช ุงุดุชุจุงู ุจุจูุฏ.

### ูุดฺฉู 5: Performance Issue ุฏุฑ Scroll Event
- **ุดุฑุญ**: ุฐุฎุฑูโุณุงุฒ ุฏุฑ ูุฑ scroll event ูโุชูุงูุฏ ุณูฺฏู ุจุงุดุฏ.
- **ุชุฃุซุฑ**: ููฺฉู ุงุณุช scroll laggy ุดูุฏ.

### ูุดฺฉู 6: SessionStorage ูุญุฏูุฏุช ุฏุงุฑุฏ
- **ุดุฑุญ**: `sessionStorage` ููุท ุฏุฑ ฺฉ tab/ุณุดู ฺฉุงุฑ ูโฺฉูุฏ. ุงฺฏุฑ ฺฉุงุฑุจุฑ tab ุฑุง ุจุจูุฏุฏ ู ุฏูุจุงุฑู ุจุงุฒ ฺฉูุฏุ ูููุนุช ุงุฒ ุจู ูโุฑูุฏ.
- **ุชุฃุซุฑ**: ูููุนุช ฺฉุงุฑุจุฑ ุจุนุฏ ุงุฒ ุจุณุชู tab ุงุฒ ุจู ูโุฑูุฏ.

---

## โ ูพุดููุงุฏุงุช ุจูุจูุฏ

### ูพุดููุงุฏ 1: ุงุถุงูู ฺฉุฑุฏู ููุทู "ุงููู ูพุงู ุฎูุงูุฏู ูุดุฏู"

```javascript
function findFirstUnreadMessage(lastReadMessageId) {
    if (!lastReadMessageId) {
        // ุงฺฏุฑ lastReadMessageId ูุฌูุฏ ูุฏุงุดุชุ ุจู ุงููู ูพุงู ุจุฑู
        const firstMessage = chatBox.querySelector('[data-message-id]');
        return firstMessage ? firstMessage.getAttribute('data-message-id') : null;
    }
    
    // ูพุฏุง ฺฉุฑุฏู ุงููู ูพุงู ุจุง ID ุจุฒุฑฺฏุชุฑ ุงุฒ lastReadMessageId
    const messages = Array.from(chatBox.querySelectorAll('[data-message-id]'));
    for (const msg of messages) {
        const msgId = parseInt(msg.getAttribute('data-message-id'));
        if (msgId > lastReadMessageId) {
            return msgId.toString();
        }
    }
    
    // ุงฺฏุฑ ููู ูพุงูโูุง ุฎูุงูุฏู ุดุฏูโุงูุฏุ ุจู ุขุฎุฑู ูพุงู ุจุฑู
    return null;
}
```

### ูพุดููุงุฏ 2: ุจูุจูุฏ ุงูููุชโุจูุฏ Scroll Restore

**ุงูููุช ุฌุฏุฏ:**
1. **ุงูููุช 1**: ุงฺฏุฑ `lastReadMessageId` ูุฌูุฏ ุฏุงุฑุฏ โ ุจู **ุงููู ูพุงู ุฎูุงูุฏู ูุดุฏู** ุจุฑู
2. **ุงูููุช 2**: ุงฺฏุฑ `lastReadMessageId` ูุฌูุฏ ุฏุงุฑุฏ ุงูุง ูพุงู ุฏุฑ DOM ูุณุช โ ุงููู ูพุงู ุจุง ID ุจุฒุฑฺฏุชุฑ ุฑุง ูพุฏุง ฺฉู
3. **ุงูููุช 3**: ุงฺฏุฑ `sessionStorage` ูููุนุช ุฏุงุฑุฏ โ ุจู ููุงู ูููุนุช ุจุฑู
4. **ุงูููุช 4**: ุงฺฏุฑ `lastReadMessageId` null ุงุณุช โ ุจู ุงููู ูพุงู ฺฏุฑูู ุจุฑู
5. **ุงูููุช 5**: ุงฺฏุฑ ูฺ ฺฉุฏุงู ูุจูุฏ โ ุจู ุขุฎุฑู ูพุงู ุจุฑู

### ูพุดููุงุฏ 3: ุงุณุชูุงุฏู ุงุฒ Debounce ุจุฑุง ุฐุฎุฑู Scroll Position

```javascript
let scrollSaveTimeout = null;
chatBox.addEventListener('scroll', () => {
    clearTimeout(scrollSaveTimeout);
    scrollSaveTimeout = setTimeout(() => {
        sessionStorage.setItem(STORAGE_KEY, chatBox.scrollTop);
    }, 500); // ููุท ูุฑ 500ms ฺฉ ุจุงุฑ ุฐุฎุฑู ฺฉู
});
```

### ูพุดููุงุฏ 4: ุจูุจูุฏ ููุทู Polling

```javascript
// ุฏุฑ pollingุ ุจุฑุฑุณ ฺฉู ฺฉู ุขุง scroll restore ุดุฏู ุงุณุช
if (isScrolledToBottom && window.scrollPositionRestored) {
    // ููุท ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฎูุฏุด ุจู ูพุงู ุฑูุชู ุจุงุดุฏุ ุจุง ูพุงูโูุง ุฌุฏุฏ ุจู ูพุงู ุจุฑู
    chatBox.scrollTop = chatBox.scrollHeight;
} else if (!window.scrollPositionRestored) {
    // ุงฺฏุฑ scroll restore ูุดุฏูุ ุตุจุฑ ฺฉู
    return;
}
```

### ูพุดููุงุฏ 5: ุงุถุงูู ฺฉุฑุฏู Highlight ุจุฑุง ูพุงูโูุง ุฎูุงูุฏู ูุดุฏู

```javascript
function highlightUnreadMessages(lastReadMessageId) {
    if (!lastReadMessageId) return;
    
    const messages = chatBox.querySelectorAll('[data-message-id]');
    messages.forEach(msg => {
        const msgId = parseInt(msg.getAttribute('data-message-id'));
        if (msgId > lastReadMessageId) {
            msg.classList.add('unread-message');
        }
    });
    
    // ุจุนุฏ ุงุฒ 5 ุซุงูู highlight ุฑุง ุญุฐู ฺฉู
    setTimeout(() => {
        document.querySelectorAll('.unread-message').forEach(msg => {
            msg.classList.remove('unread-message');
        });
    }, 5000);
}
```

### ูพุดููุงุฏ 6: ุงุณุชูุงุฏู ุงุฒ localStorage ุจู ุฌุง sessionStorage (ุงุฎุชุงุฑ)

ุจุฑุง ุญูุธ ูููุนุช ุญุช ุจุนุฏ ุงุฒ ุจุณุชู tab:
```javascript
// ุงุณุชูุงุฏู ุงุฒ localStorage ุจุฑุง ุญูุธ ูููุนุช ุจู sessionโูุง
localStorage.setItem(`chatScroll_${groupId}_${userId}`, chatBox.scrollTop);
```

---

## ๐ ุฎูุงุตู ูุดฺฉูุงุช ู ุฑุงูโุญูโูุง

| ูุดฺฉู | ุชุฃุซุฑ | ุฑุงูโุญู ูพุดููุงุฏ |
|------|-------|----------------|
| ูุจูุฏ ููุทู "ุงููู ูพุงู ุฎูุงูุฏู ูุดุฏู" | ฺฉุงุฑุจุฑ ุจุงุฏ ุฏุณุช scroll ฺฉูุฏ | ุงุถุงูู ฺฉุฑุฏู ุชุงุจุน `findFirstUnreadMessage` |
| ุงฺฏุฑ `lastReadMessageId` ุฏุฑ DOM ูุจุงุดุฏ | fallback ุจู ูููุนุช ุงุดุชุจุงู | ูพุฏุง ฺฉุฑุฏู ุงููู ูพุงู ุจุนุฏ ุงุฒ `lastReadMessageId` |
| ูุฑูุฏ ุงููู ฺฉุงุฑุจุฑ (`lastReadMessageId = null`) | ุจู ุขุฎุฑ ูโุฑูุฏ ูู ุงูู | ุฑูุชู ุจู ุงููู ูพุงู ฺฏุฑูู |
| ุชุฏุงุฎู Polling ู Scroll Restore | ูููุนุช ุงุดุชุจุงู | ฺฺฉ ฺฉุฑุฏู `scrollPositionRestored` ูุจู ุงุฒ polling |
| Performance ุฏุฑ Scroll Event | scroll laggy | ุงุณุชูุงุฏู ุงุฒ debounce |
| ูุญุฏูุฏุช SessionStorage | ุงุฒ ุฏุณุช ุฑูุชู ูููุนุช | ุงุณุชูุงุฏู ุงุฒ localStorage (ุงุฎุชุงุฑ) |

---

## ๐ฏ ุงูููุช ูพุงุฏูโุณุงุฒ

1. **ููุฑ**: ุงุถุงูู ฺฉุฑุฏู ููุทู "ุงููู ูพุงู ุฎูุงูุฏู ูุดุฏู"
2. **ููู**: ุจูุจูุฏ fallback ุจุฑุง ุฒูุงู ฺฉู `lastReadMessageId` ุฏุฑ DOM ูุณุช
3. **ููู**: ุงุตูุงุญ ููุทู ูุฑูุฏ ุงููู (ุฑูุชู ุจู ุงููู ูพุงู ุจู ุฌุง ุขุฎุฑู)
4. **ูุชูุณุท**: ุงุณุชูุงุฏู ุงุฒ debounce ุจุฑุง ุฐุฎุฑู scroll position
5. **ูุชูุณุท**: ุจูุจูุฏ ููุทู polling ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุชุฏุงุฎู
6. **ฺฉู**: ุงุณุชูุงุฏู ุงุฒ localStorage (ุงุฎุชุงุฑ)

