<?php

namespace App\Services\NajmHoda\Agents;

use App\Services\NajmHoda\BaseAgent;
use App\Models\User;

/**
 * Ø¹Ø§Ù…Ù„ Ù…Ù‡Ù…Ø§Ù†Ø¯Ø§Ø± Ù†Ø¬Ù…â€ŒÙ‡Ø¯Ø§
 * 
 * Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§:
 * - Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
 * - Ø¢Ù…ÙˆØ²Ø´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯
 * - Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ùˆ ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§
 * - Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ
 * - Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†Ø¬Ù…Ù† Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
 */
class StewardAgent extends BaseAgent
{
    protected string $role = 'steward';
    
    protected array $expertise = [
        'user_support',
        'onboarding',
        'training',
        'feedback_collection',
        'community_management',
        'content_creation',
        'communication',
        'user_engagement',
    ];
    
    public function getSystemPrompt(): string
    {
        return "Ø´Ù…Ø§ Ù…Ù‡Ù…Ø§Ù†Ø¯Ø§Ø± (Ù¾Ø´ØªÛŒØ¨Ø§Ù†) Ù¾Ø±ÙˆÚ˜Ù‡ NewEarthCoop Ù‡Ø³ØªÛŒØ¯ Ùˆ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ù†Ø¬Ù…â€ŒÙ‡Ø¯Ø§.

**Ù†Ø§Ù… Ø´Ù…Ø§:** Ù…Ù‡Ù…Ø§Ù†Ø¯Ø§Ø± Ù†Ø¬Ù…â€ŒÙ‡Ø¯Ø§ ğŸ‘¨â€âœˆï¸

**Ù…Ø§Ù…ÙˆØ±ÛŒØª:**
Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ù‡ØªØ±ÛŒÙ† ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø±Ø«Ú©ÙˆÙ¾ Ùˆ Ú©Ù…Ú© Ø¨Ù‡ Ø¢Ù†Ù‡Ø§ Ø¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³ÛŒØ³ØªÙ…

**Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§:**
1. Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù‡ Ø²Ø¨Ø§Ù† Ø³Ø§Ø¯Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ ÙÙ‡Ù…
2. Ø¢Ù…ÙˆØ²Ø´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ (Onboarding)
3. Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ùˆ ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§
4. Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ (Ø±Ø§Ù‡Ù†Ù…Ø§Ù‡Ø§ØŒ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ØŒ FAQ)
5. Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ ØªÙ‚ÙˆÛŒØª Ø§Ù†Ø¬Ù…Ù† Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
6. Ø§Ø±ØªØ¨Ø§Ø· Ù…Ø¤Ø«Ø± Ùˆ Ù‡Ù…Ø¯Ù„Ø§Ù†Ù‡ Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
7. Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†ÛŒØ§Ø²Ù‡Ø§ Ùˆ Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
8. Ú¯Ø²Ø§Ø±Ø´ Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ù‡ ØªÛŒÙ… ÙÙ†ÛŒ

**Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø±Ø«Ú©ÙˆÙ¾:**
Ø§Ø±Ø«Ú©ÙˆÙ¾ ÛŒÚ© Ù¾Ù„ØªÙØ±Ù… ØªØ¹Ø§ÙˆÙ†ÛŒ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø§Ø³Øª Ú©Ù‡:
- Ø§Ù…Ú©Ø§Ù† Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¹Ø§Ø¯Ù„Ø§Ù†Ù‡ Ùˆ Ø¯Ù…ÙˆÚ©Ø±Ø§ØªÛŒÚ©
- Ø´Ø±Ú©Øª Ø¯Ø± Ø­Ø±Ø§Ø¬â€ŒÙ‡Ø§ Ùˆ Ù…Ø²Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§
- Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„ Ùˆ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§
- ØªØ¹Ø§Ù…Ù„ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ø¨Ø§ Ø³Ø§ÛŒØ± Ø§Ø¹Ø¶Ø§
- Ø´ÙØ§ÙÛŒØª Ú©Ø§Ù…Ù„ Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§

**ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø³ÛŒØ³ØªÙ…:**
- Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø§Ù…Ù†
- Ø­Ø±Ø§Ø¬â€ŒÙ‡Ø§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†
- Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¯ÛŒØ¬ÛŒØªØ§Ù„
- Ø³ÛŒØ³ØªÙ… Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ
- Ø§Ù†Ø¬Ù…Ù† Ùˆ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§
- Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ù…Ø§Ù„ÛŒ

**Ù†Ø­ÙˆÙ‡ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø´Ù…Ø§:**
- Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø¤Ø¯Ø¨ØŒ ØµØ¨ÙˆØ± Ùˆ Ù…Ù‡Ø±Ø¨Ø§Ù† Ø¨Ø§Ø´ÛŒØ¯
- Ø¨Ù‡ Ø²Ø¨Ø§Ù† Ø³Ø§Ø¯Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ ÙÙ‡Ù… ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯
- Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ Ùˆ ÙˆØ§Ø¶Ø­ Ø§Ø±Ø§Ø¦Ù‡ Ú©Ù†ÛŒØ¯
- Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²ØŒ ØªØµÙˆÛŒØ± ÛŒØ§ ÙˆÛŒØ¯Ø¦Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¯Ù‡ÛŒØ¯
- Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø± Ù‡Ù…Ø¯Ù„ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø­Ø³Ø§Ø³Ø´ Ø±Ø§ Ø¯Ø±Ú© Ú©Ù†ÛŒØ¯
- Ø§Ú¯Ø± Ø¬ÙˆØ§Ø¨ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŒ ØµØ§Ø¯Ù‚Ø§Ù†Ù‡ Ø¨Ú¯ÙˆÛŒÛŒØ¯ Ùˆ Ø¨Ù‡ ØªÛŒÙ… ÙÙ†ÛŒ Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ù‡ÛŒØ¯
- Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø«Ø¨Øª Ùˆ Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ú©Ù†Ù†Ø¯Ù‡ Ø¨Ø§Ø´ÛŒØ¯

**Ù…Ø«Ø§Ù„ Ù¾Ø§Ø³Ø® Ø´Ù…Ø§:**
```
Ø³Ù„Ø§Ù…! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ Ø§Ø±Ø«Ú©ÙˆÙ¾ ğŸŒŸ

Ù…Ù† Ù…Ù‡Ù…Ø§Ù†Ø¯Ø§Ø± Ù†Ø¬Ù…â€ŒÙ‡Ø¯Ø§ Ù‡Ø³ØªÙ… Ùˆ Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©ØªÙˆÙ† Ú©Ù†Ù…!

Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹:

1ï¸âƒ£ **Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯:**
   - Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ \"Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…\" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯
   - Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
   - Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯

2ï¸âƒ£ **Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª:**
   - Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ø¨ÛŒØ´ØªØ±ØŒ Ù‡ÙˆÛŒØª Ø®ÙˆØ¯ Ø±Ø§ ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯
   - Ù…Ø¯Ø§Ø±Ú© Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²: Ú©Ø§Ø±Øª Ù…Ù„ÛŒØŒ Ø¹Ú©Ø³

3ï¸âƒ£ **Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„:**
   - Ø§Ø² Ø¨Ø®Ø´ \"Ú©ÛŒÙ Ù¾ÙˆÙ„\" Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†ÛŒØ¯
   - Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª: Ú©Ø§Ø±Øª Ø¨Ø§Ù†Ú©ÛŒØŒ ÙˆØ§Ø±ÛŒØ²

4ï¸âƒ£ **Ø´Ø±Ú©Øª Ø¯Ø± Ø­Ø±Ø§Ø¬:**
   - Ø­Ø±Ø§Ø¬â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯
   - Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‚ÛŒÙ…Øª Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯

Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ù…Ù† Ù‡Ù…ÛŒØ´Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ø³ØªÙ…! ğŸ˜Š
```

**Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„ (FAQ):**
- Ú†Ø·ÙˆØ± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†Ù…ØŸ
- Ú†Ø·ÙˆØ± Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ø§Ø±Ú˜ Ú©Ù†Ù…ØŸ
- Ú†Ø·ÙˆØ± Ø¯Ø± Ø­Ø±Ø§Ø¬ Ø´Ø±Ú©Øª Ú©Ù†Ù…ØŸ
- Ø³ÛŒØ³ØªÙ… Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ú†Ú¯ÙˆÙ†Ù‡ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ
- Ú†Ø·ÙˆØ± Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ Ú¯Ø²Ø§Ø±Ø´ Ú©Ù†Ù…ØŸ

Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒØŒ ØµÙ…ÛŒÙ…ÛŒ Ùˆ Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯!";
    }
    
    /**
     * Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„ Ú©Ø§Ø±Ø¨Ø±
     */
    public function answerQuestion(string $question, array $userContext = []): array
    {
        $context = $this->buildUserContext($userContext);
        
        $prompt = "Ú©Ø§Ø±Ø¨Ø± Ø³ÙˆØ§Ù„ Ø²ÛŒØ± Ø±Ø§ Ù¾Ø±Ø³ÛŒØ¯Ù‡:

**Ø³ÙˆØ§Ù„:** {$question}

**Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±:**
{$context}

Ù„Ø·ÙØ§Ù‹:
1. Ù¾Ø§Ø³Ø® Ú©Ø§Ù…Ù„ Ùˆ ÙˆØ§Ø¶Ø­ Ø¨Ø¯Ù‡ (Ø¨Ù‡ Ø²Ø¨Ø§Ù† Ø³Ø§Ø¯Ù‡)
2. Ú¯Ø§Ù… Ø¨Ù‡ Ú¯Ø§Ù… ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯Ù‡ (Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ø§Ø´Ø¯)
3. Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÛŒ Ø¨Ø²Ù†
4. Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙÛŒØ¯ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø¯Ù‡ (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯)
5. Ø³ÙˆØ§Ù„Ø§Øª Ù…Ø±ØªØ¨Ø· Ø±Ø§ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ú©Ù†

**Ù…Ù‡Ù…:**
- Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ ÙÙ†ÛŒ Ùˆ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ø§Ø³ØªØŒ Ø¨Ù‡ ØªÛŒÙ… ÙÙ†ÛŒ Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ø¯Ù‡
- Ø§Ú¯Ø± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø³ØªØŒ Ø¯Ù‚Øª Ø²ÛŒØ§Ø¯ÛŒ Ú©Ù†
- Ù‡Ù…ÛŒØ´Ù‡ Ø§Ù…Ù†ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±

Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ù‡ ÙØ±Ù…Øª JSON:
```json
{
  \"answer\": \"Ù¾Ø§Ø³Ø® Ú©Ø§Ù…Ù„\",
  \"steps\": [\"Ú¯Ø§Ù… 1\", \"Ú¯Ø§Ù… 2\"],
  \"example\": \"Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÛŒ\",
  \"related_links\": [],
  \"related_questions\": [],
  \"needs_escalation\": false,
  \"escalation_reason\": \"\"
}
```";

        $response = $this->ask($prompt, $userContext);
        
        return $this->parseJsonResponse($response);
    }
    
    /**
     * Ø¢Ù…ÙˆØ²Ø´ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
     */
    public function onboardUser(User $user): array
    {
        $prompt = "ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡:

**Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±:**
- Ù†Ø§Ù…: {$user->name}
- Ø§ÛŒÙ…ÛŒÙ„: {$user->email}
- ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª: {$user->created_at->format('Y-m-d')}

ÛŒÚ© Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø³Ø§Ø² Ú©Ù‡ Ø´Ø§Ù…Ù„:

1. **Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ:**
   - Ú¯Ø±Ù… Ùˆ ØµÙ…ÛŒÙ…ÛŒ
   - Ù‡ÛŒØ¬Ø§Ù†â€ŒØ§Ù†Ú¯ÛŒØ²
   - Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ú©Ù†Ù†Ø¯Ù‡

2. **Ø¢Ø´Ù†Ø§ÛŒÛŒ Ø¨Ø§ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ:**
   - 5 ÙˆÛŒÚ˜Ú¯ÛŒ Ù…Ù‡Ù…
   - ØªÙˆØ¶ÛŒØ­ Ø³Ø§Ø¯Ù‡ Ù‡Ø± Ú©Ø¯Ø§Ù…

3. **Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù‚Ø¯Ù… Ø¨Ù‡ Ù‚Ø¯Ù…:**
   - Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø±Ù‡Ø§ (First Steps)
   - ØªÚ©Ù…ÛŒÙ„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
   - Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
   - Ø§ÙˆÙ„ÛŒÙ† Ø­Ø±Ø§Ø¬

4. **Ù…Ù†Ø§Ø¨Ø¹ Ø¢Ù…ÙˆØ²Ø´ÛŒ:**
   - ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§
   - Ø±Ø§Ù‡Ù†Ù…Ø§Ù‡Ø§ÛŒ Ù†ÙˆØ´ØªØ§Ø±ÛŒ
   - FAQ

5. **Ù†Ú©Ø§Øª Ù…Ù‡Ù…:**
   - Ø§Ù…Ù†ÛŒØª
   - Ø¨Ù‡ØªØ±ÛŒÙ† Ø±ÙˆØ´â€ŒÙ‡Ø§
   - Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø±Ø§ÛŒØ¬

6. **Ø±Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù…Ú©:**
   - Ú†Øª Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ
   - Ø§ÛŒÙ…ÛŒÙ„
   - Ø§Ù†Ø¬Ù…Ù†

Ø®Ø±ÙˆØ¬ÛŒ: JSON Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ú©Ø§Ù…Ù„";

        $response = $this->ask($prompt);
        
        return $this->parseJsonResponse($response);
    }
    
    /**
     * ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§
     */
    public function analyzeFeedback($feedbacks): array
    {
        $feedbackText = $this->formatFeedbacks($feedbacks);
        
        $prompt = "Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ ØªØ­Ù„ÛŒÙ„ Ú©Ù†:

{$feedbackText}

ØªØ­Ù„ÛŒÙ„ Ø´Ø§Ù…Ù„:

1. **Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø§ØµÙ„ÛŒ (Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ):**
   - Ù…Ø´Ú©Ù„Ø§Øª ÙÙ†ÛŒ
   - Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒ
   - Ù†Ø§Ø±Ø¶Ø§ÛŒØªÛŒâ€ŒÙ‡Ø§
   - ØªØ­Ø³ÛŒÙ†â€ŒÙ‡Ø§

2. **Ø§Ø­Ø³Ø§Ø³Ø§Øª Ú©Ù„ÛŒ:**
   - Ù…Ø«Ø¨Øª: X%
   - Ù…Ù†ÙÛŒ: Y%
   - Ø®Ù†Ø«ÛŒ: Z%

3. **Ù…Ø´Ú©Ù„Ø§Øª Ù¾Ø±ØªÚ©Ø±Ø§Ø±:**
   - Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø§Ù„Ú¯ÙˆÙ‡Ø§
   - Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ

4. **Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:**
   - ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
   - Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§

5. **Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª:**
   - ÙÙˆØ±ÛŒ (Critical)
   - Ù…Ù‡Ù… (High)
   - Ù…ØªÙˆØ³Ø· (Medium)
   - Ú©Ù… (Low)

6. **Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:**
   - Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù…Ù†ÙÛŒ
   - Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª

7. **Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª:**
   - Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª
   - ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ

ÙØ±Ù…Øª: JSON";

        $response = $this->ask($prompt);
        
        return $this->parseJsonResponse($response);
    }
    
    /**
     * Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ
     */
    public function createTutorial(string $topic, string $format = 'markdown'): string
    {
        $prompt = "ÛŒÚ© Ø¢Ù…ÙˆØ²Ø´ Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¶ÙˆØ¹ Ø²ÛŒØ± Ø¨Ø³Ø§Ø²:

**Ù…ÙˆØ¶ÙˆØ¹:** {$topic}

Ù…Ø­ØªÙˆØ§ Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„:

1. **Ù…Ù‚Ø¯Ù…Ù‡:**
   - Ú†Ø±Ø§ Ø§ÛŒÙ† Ù…Ù‡Ù… Ø§Ø³ØªØŸ
   - Ú†Ù‡ Ú©Ø³Ø§Ù†ÛŒ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ù†Ø¯ØŸ

2. **Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§:**
   - Ø¯Ø§Ù†Ø´ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
   - Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§

3. **Ø¢Ù…ÙˆØ²Ø´ Ú¯Ø§Ù… Ø¨Ù‡ Ú¯Ø§Ù…:**
   - ØªÙˆØ¶ÛŒØ­Ø§Øª ÙˆØ§Ø¶Ø­
   - ØªØµØ§ÙˆÛŒØ± (ØªÙˆØµÛŒÙ Ù…Ø­Ù„)
   - Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ

4. **Ù†Ú©Ø§Øª Ùˆ ØªØ±ÙÙ†Ø¯Ù‡Ø§:**
   - Tips Ù…ÙÛŒØ¯
   - Ù…ÛŒØ§Ù†Ø¨Ø±Ù‡Ø§

5. **Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ÛŒØ¬ Ùˆ Ø±Ø§Ù‡ Ø­Ù„:**
   - Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„
   - Ù†Ø­ÙˆÙ‡ Ø±ÙØ¹

6. **Ù…Ù†Ø§Ø¨Ø¹ Ø¨ÛŒØ´ØªØ±:**
   - Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙÛŒØ¯
   - ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·

**ÙØ±Ù…Øª:** {$format}
**Ø²Ø¨Ø§Ù†:** ÙØ§Ø±Ø³ÛŒ Ø³Ø§Ø¯Ù‡ Ùˆ Ø±ÙˆØ§Ù†
**Ù„Ø­Ù†:** Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ùˆ Ø¢Ù…ÙˆØ²Ø´ÛŒ

ÙÙ‚Ø· Ù…Ø­ØªÙˆØ§ Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ØŒ Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒ.";

        return $this->ask($prompt);
    }
    
    /**
     * Ø§ÛŒØ¬Ø§Ø¯ FAQ
     */
    public function generateFAQ(string $category = 'general'): array
    {
        $prompt = "ÛŒÚ© Ù„ÛŒØ³Øª FAQ (Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„) Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙ‡ \"{$category}\" Ø¨Ø³Ø§Ø²:

Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ÙˆØ§Ù„:
- Ø³ÙˆØ§Ù„ ÙˆØ§Ø¶Ø­ Ùˆ Ù…Ø³ØªÙ‚ÛŒÙ…
- Ù¾Ø§Ø³Ø® Ú©Ø§Ù…Ù„ Ø§Ù…Ø§ Ù…Ø®ØªØµØ±
- Ù…Ø«Ø§Ù„ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)
- Ù„ÛŒÙ†Ú© Ù…Ø±ØªØ¨Ø· (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯)

Ø­Ø¯Ø§Ù‚Ù„ 10 Ø³ÙˆØ§Ù„ Ù…ØªØ¯Ø§ÙˆÙ„.

Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§:
- Ø¹Ù…ÙˆÙ…ÛŒ (general)
- Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
- Ú©ÛŒÙ Ù¾ÙˆÙ„ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª
- Ø­Ø±Ø§Ø¬ Ùˆ Ù…Ø²Ø§ÛŒØ¯Ù‡
- Ø§Ù…Ù†ÛŒØª
- Ù…Ø´Ú©Ù„Ø§Øª ÙÙ†ÛŒ

ÙØ±Ù…Øª: JSON
```json
{
  \"category\": \"\",
  \"faqs\": [
    {
      \"question\": \"\",
      \"answer\": \"\",
      \"example\": \"\",
      \"related_link\": \"\"
    }
  ]
}
```";

        $response = $this->ask($prompt);
        
        return $this->parseJsonResponse($response);
    }
    
    /**
     * Ø³Ø§Ø®Øª context Ú©Ø§Ø±Ø¨Ø±
     */
    protected function buildUserContext(array $userContext): string
    {
        $context = [];
        
        if (isset($userContext['user_id'])) {
            try {
                $user = User::find($userContext['user_id']);
                if ($user) {
                    $context[] = "Ù†Ø§Ù…: {$user->name}";
                    $context[] = "Ø¹Ø¶ÙˆÛŒØª Ø§Ø²: {$user->created_at->diffForHumans()}";
                    $context[] = "Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯: " . ($user->last_login ? $user->last_login->diffForHumans() : 'Ù‡Ø±Ú¯Ø²');
                }
            } catch (\Exception $e) {
                // ignore
            }
        }
        
        if (isset($userContext['previous_questions'])) {
            $context[] = "Ø³ÙˆØ§Ù„Ø§Øª Ù‚Ø¨Ù„ÛŒ: " . implode(', ', $userContext['previous_questions']);
        }
        
        return empty($context) ? 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª' : implode("\n", $context);
    }
    
    /**
     * ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§
     */
    protected function formatFeedbacks($feedbacks): string
    {
        if (is_string($feedbacks)) {
            return $feedbacks;
        }
        
        if (is_array($feedbacks) || is_object($feedbacks)) {
            $formatted = [];
            foreach ($feedbacks as $index => $feedback) {
                $content = is_object($feedback) ? $feedback->content : ($feedback['content'] ?? '');
                $rating = is_object($feedback) ? ($feedback->rating ?? 'N/A') : ($feedback['rating'] ?? 'N/A');
                
                $formatted[] = "[Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ #{$index}] Ø§Ù…ØªÛŒØ§Ø²: {$rating}/5\n{$content}";
            }
            return implode("\n---\n", $formatted);
        }
        
        return 'Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯';
    }
    
    /**
     * Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø³Ø® JSON
     */
    protected function parseJsonResponse(string $response): array
    {
        try {
            $response = preg_replace('/```json\s*(.*?)\s*```/s', '$1', $response);
            $response = preg_replace('/```\s*(.*?)\s*```/s', '$1', $response);
            
            $decoded = json_decode(trim($response), true);
            
            if (json_last_error() === JSON_ERROR_NONE) {
                return $decoded;
            }
            
            return ['raw_response' => $response];
        } catch (\Exception $e) {
            return ['raw_response' => $response, 'error' => $e->getMessage()];
        }
    }
}
